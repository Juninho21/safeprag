rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // Helper Functions
    // ========================================
    
    // Verifica se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Obtém o role do usuário dos custom claims
    function getRole() {
      return request.auth.token.role;
    }
    
    // Obtém o companyId do usuário dos custom claims
    function getCompanyId() {
      return request.auth.token.companyId;
    }
    
    // Verifica se o usuário é admin
    function isAdmin() {
      return isAuthenticated() && getRole() == 'admin';
    }
    
    // Verifica se o usuário é admin ou controlador
    function isAdminOrController() {
      return isAuthenticated() && (getRole() == 'admin' || getRole() == 'controlador');
    }
    
    // Verifica se o usuário pertence à mesma empresa
    function isSameCompany(companyId) {
      return isAuthenticated() && getCompanyId() == companyId;
    }
    
    // ========================================
    // Companies Collection
    // ========================================
    
    match /companies/{companyId} {
      // Usuários podem ler dados da própria empresa
      allow read: if isSameCompany(companyId);
      
      // Apenas admins podem atualizar dados da empresa
      allow update: if isSameCompany(companyId) && isAdmin();
      
      // Criar e deletar empresas só via Admin API (service account)
      // Usuários normais não podem criar/deletar empresas
      allow create, delete: if false;
      
      // ========================================
      // Subcoleções da Empresa
      // ========================================
      
      // Users subcollection
      match /users/{userId} {
        // Todos os usuários da empresa podem ver lista de usuários
        allow read: if isSameCompany(companyId);
        
        // Apenas admins podem criar/atualizar/deletar usuários
        allow create, update, delete: if isSameCompany(companyId) && isAdmin();
      }
      
      // Clients subcollection
      match /clients/{clientId} {
        // Todos os usuários da empresa podem ler clientes
        allow read: if isSameCompany(companyId);
        
        // Admins e controladores podem criar/atualizar
        allow create, update: if isSameCompany(companyId) && isAdminOrController();
        
        // Apenas admins podem deletar
        allow delete: if isSameCompany(companyId) && isAdmin();
      }
      
      // Products subcollection
      match /products/{productId} {
        // Todos os usuários da empresa podem ler produtos
        allow read: if isSameCompany(companyId);
        
        // Admins e controladores podem criar/atualizar
        allow create, update: if isSameCompany(companyId) && isAdminOrController();
        
        // Apenas admins podem deletar
        allow delete: if isSameCompany(companyId) && isAdmin();
      }
      
      // Schedules subcollection
      match /schedules/{scheduleId} {
        // Todos os usuários da empresa podem ler agendamentos
        allow read: if isSameCompany(companyId);
        
        // Admins e controladores podem criar/atualizar
        allow create, update: if isSameCompany(companyId) && isAdminOrController();
        
        // Apenas admins podem deletar
        allow delete: if isSameCompany(companyId) && isAdmin();
      }
      
      // Service Orders subcollection
      match /service_orders/{orderId} {
        // Todos os usuários da empresa podem ler ordens de serviço
        allow read: if isSameCompany(companyId);
        
        // Admins e controladores podem criar/atualizar
        allow create, update: if isSameCompany(companyId) && isAdminOrController();
        
        // Apenas admins podem deletar
        allow delete: if isSameCompany(companyId) && isAdmin();
      }
      
      // Devices subcollection
      match /devices/{deviceId} {
        // Todos os usuários da empresa podem ler dispositivos
        allow read: if isSameCompany(companyId);
        
        // Admins e controladores podem criar/atualizar
        allow create, update: if isSameCompany(companyId) && isAdminOrController();
        
        // Apenas admins podem deletar
        allow delete: if isSameCompany(companyId) && isAdmin();
      }
      
      // Signatures subcollection
      match /signatures/{signatureId} {
        // Todos os usuários da empresa podem ler assinaturas
        allow read: if isSameCompany(companyId);
        
        // Admins e controladores podem criar/atualizar
        allow create, update: if isSameCompany(companyId) && isAdminOrController();
        
        // Apenas admins podem deletar
        allow delete: if isSameCompany(companyId) && isAdmin();
      }
      
      // Service Order PDFs subcollection
      match /service_order_pdfs/{pdfId} {
        // Todos os usuários da empresa podem ler PDFs
        allow read: if isSameCompany(companyId);
        
        // Admins e controladores podem criar/atualizar
        allow create, update: if isSameCompany(companyId) && isAdminOrController();
        
        // Apenas admins podem deletar
        allow delete: if isSameCompany(companyId) && isAdmin();
      }
      
      // Regra genérica para qualquer outra subcoleção
      match /{subcollection}/{docId} {
        // Todos os usuários da empresa podem ler
        allow read: if isSameCompany(companyId);
        
        // Admins e controladores podem criar/atualizar
        allow create, update: if isSameCompany(companyId) && isAdminOrController();
        
        // Apenas admins podem deletar
        allow delete: if isSameCompany(companyId) && isAdmin();
      }
    }
    
    // ========================================
    // Deny All Other Access
    // ========================================
    
    // Qualquer documento fora da estrutura companies/ é negado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
